<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>autodocs - API Playground</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e4e4e7;
    }

    /* ── Top bar ── */
    #topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: #18181b;
      border-bottom: 1px solid #27272a;
      backdrop-filter: blur(12px);
    }

    #topbar .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      color: #e4e4e7;
      letter-spacing: -0.01em;
    }

    #topbar .brand span.logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 6px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      font-weight: 700;
      font-size: 13px;
    }

    #topbar .brand em {
      font-style: normal;
      color: #71717a;
      font-weight: 400;
      margin-left: 4px;
    }

    /* ── Renderer selector ── */
    .renderer-select-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .renderer-select-wrapper label {
      font-size: 12px;
      color: #71717a;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 500;
    }

    #rendererSelect {
      appearance: none;
      -webkit-appearance: none;
      background: #27272a;
      color: #e4e4e7;
      border: 1px solid #3f3f46;
      border-radius: 6px;
      padding: 6px 32px 6px 12px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      outline: none;
      transition: border-color 0.15s;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
    }

    #rendererSelect:hover { border-color: #6366f1; }
    #rendererSelect:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99,102,241,0.25); }

    /* ── Content area ── */
    #content {
      margin-top: 48px;
      min-height: calc(100vh - 48px);
    }

    /* ── Error / loading states ── */
    .state-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: calc(100vh - 48px);
      color: #71717a;
      font-size: 1.1rem;
      gap: 12px;
      text-align: center;
      padding: 20px;
    }

    .state-message code {
      background: #27272a;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #a1a1aa;
    }

    .state-message .error-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(239,68,68,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ef4444;
      font-size: 24px;
      font-weight: 700;
    }

    .state-message .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #27272a;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Hybrid mode ── */
    #hybrid-wrapper {
      display: flex;
      height: calc(100vh - 48px);
    }

    #hybrid-redoc {
      flex: 1;
      overflow-y: auto;
    }

    #hybrid-try-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9998;
      padding: 12px 24px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(99,102,241,0.4);
      transition: transform 0.15s, box-shadow 0.15s;
    }

    #hybrid-try-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 24px rgba(99,102,241,0.5);
    }

    /* Swagger modal overlay */
    #swagger-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 10000;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
    }

    #swagger-panel {
      position: absolute;
      top: 0;
      right: 0;
      width: 55%;
      min-width: 480px;
      max-width: 900px;
      height: 100%;
      background: #fff;
      box-shadow: -4px 0 30px rgba(0,0,0,0.5);
      overflow-y: auto;
      animation: slideIn 0.2s ease-out;
    }

    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    #swagger-panel-close {
      position: sticky;
      top: 0;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: #1e1e1e;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
    }

    #swagger-panel-close button {
      background: #333;
      border: none;
      color: #fff;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    #swagger-panel-close button:hover { background: #555; }

    #swagger-panel-content {
      padding: 0;
    }

    /* ── RapiDoc & Stoplight overrides ── */
    rapi-doc {
      width: 100%;
      height: calc(100vh - 48px);
    }

    elements-api {
      display: block;
      min-height: calc(100vh - 48px);
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div id="topbar">
    <div class="brand">
      <span class="logo">A</span>
      autodocs <em>Playground</em>
    </div>
    <div class="renderer-select-wrapper">
      <label for="rendererSelect">Renderer</label>
      <select id="rendererSelect">
        <option value="scalar">Scalar</option>
        <option value="swagger">Swagger UI</option>
        <option value="redoc">Redoc</option>
        <option value="rapidoc">RapiDoc</option>
        <option value="stoplight">Stoplight Elements</option>
        <option value="hybrid">Hybrid (Redoc + Swagger)</option>
      </select>
    </div>
  </div>

  <!-- Renderer content -->
  <div id="content"></div>

  <script>
    // ── Params ──
    const params = new URLSearchParams(window.location.search);
    const repoId = params.get('repoId');
    const renderer = params.get('renderer') || 'scalar';

    // Set the dropdown to the current renderer
    const selectEl = document.getElementById('rendererSelect');
    selectEl.value = renderer;

    // Switching renderer updates URL and reloads
    selectEl.addEventListener('change', function () {
      const newRenderer = this.value;
      const url = new URL(window.location);
      url.searchParams.set('renderer', newRenderer);
      window.location.href = url.toString();
    });

    const contentEl = document.getElementById('content');

    // ── Utility: escape HTML to prevent XSS ──
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ── Utility: show state messages ──
    function showError(msg, detail) {
      contentEl.innerHTML =
        '<div class="state-message">' +
          '<div class="error-icon">!</div>' +
          '<div>' + escapeHtml(msg) + '</div>' +
          (detail ? '<code>' + escapeHtml(detail) + '</code>' : '') +
        '</div>';
    }

    function showLoading(msg) {
      contentEl.innerHTML =
        '<div class="state-message">' +
          '<div class="spinner"></div>' +
          '<div>' + escapeHtml(msg || 'Loading...') + '</div>' +
        '</div>';
    }

    // ── Utility: dynamically load a script ──
    function loadScript(src) {
      return new Promise(function (resolve, reject) {
        // Check if already loaded
        if (document.querySelector('script[src="' + src + '"]')) {
          resolve();
          return;
        }
        var s = document.createElement('script');
        s.src = src;
        s.onload = resolve;
        s.onerror = function () { reject(new Error('Failed to load script: ' + src)); };
        document.head.appendChild(s);
      });
    }

    // ── Utility: dynamically load a stylesheet ──
    function loadCSS(href) {
      return new Promise(function (resolve, reject) {
        if (document.querySelector('link[href="' + href + '"]')) {
          resolve();
          return;
        }
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        link.onload = resolve;
        link.onerror = function () { reject(new Error('Failed to load stylesheet: ' + href)); };
        document.head.appendChild(link);
      });
    }

    // ── Renderer implementations ──

    function renderScalar(specJson) {
      return loadScript('https://cdn.jsdelivr.net/npm/@scalar/api-reference').then(function () {
        contentEl.innerHTML = '';
        var el = document.createElement('div');
        el.id = 'scalar-root';
        contentEl.appendChild(el);
        Scalar.createApiReference('#scalar-root', {
          content: specJson,
          theme: 'default',
        });
      });
    }

    function renderSwagger(specJson) {
      return Promise.all([
        loadScript('https://cdn.jsdelivr.net/npm/swagger-ui-dist@5/swagger-ui-bundle.js'),
        loadScript('https://cdn.jsdelivr.net/npm/swagger-ui-dist@5/swagger-ui-standalone-preset.js'),
        loadCSS('https://cdn.jsdelivr.net/npm/swagger-ui-dist@5/swagger-ui.css'),
      ]).then(function () {
        contentEl.innerHTML = '<div id="swagger-root"></div>';
        SwaggerUIBundle({
          spec: specJson,
          dom_id: '#swagger-root',
          deepLinking: true,
          presets: [
            SwaggerUIBundle.presets.apis,
            SwaggerUIStandalonePreset,
          ],
          layout: 'StandaloneLayout',
        });
      });
    }

    function renderRedoc(specJson) {
      return loadScript('https://cdn.jsdelivr.net/npm/redoc@2/bundles/redoc.standalone.js').then(function () {
        contentEl.innerHTML = '<div id="redoc-root"></div>';
        Redoc.init(specJson, {}, document.getElementById('redoc-root'));
      });
    }

    function renderRapidoc(specJson) {
      return loadScript('https://cdn.jsdelivr.net/npm/rapidoc@9/dist/rapidoc-min.js').then(function () {
        contentEl.innerHTML = '';
        var el = document.createElement('rapi-doc');
        el.id = 'rapidoc';
        el.setAttribute('theme', 'dark');
        el.setAttribute('render-style', 'read');
        el.setAttribute('show-header', 'false');
        el.setAttribute('bg-color', '#0a0a0a');
        el.setAttribute('primary-color', '#6366f1');
        el.setAttribute('nav-bg-color', '#18181b');
        el.setAttribute('nav-text-color', '#a1a1aa');
        el.setAttribute('nav-accent-color', '#6366f1');
        contentEl.appendChild(el);
        // RapiDoc needs to be in the DOM before loading spec
        requestAnimationFrame(function () {
          el.loadSpec(specJson);
        });
      });
    }

    function renderStoplight(specJson) {
      return Promise.all([
        loadScript('https://cdn.jsdelivr.net/npm/@stoplight/elements@8/web-components.min.js'),
        loadCSS('https://cdn.jsdelivr.net/npm/@stoplight/elements@8/styles.min.css'),
      ]).then(function () {
        contentEl.innerHTML = '';
        var el = document.createElement('elements-api');
        el.setAttribute('apiDescriptionDocument', JSON.stringify(specJson));
        el.setAttribute('router', 'hash');
        el.setAttribute('layout', 'sidebar');
        contentEl.appendChild(el);
      });
    }

    function renderHybrid(specJson) {
      return Promise.all([
        loadScript('https://cdn.jsdelivr.net/npm/redoc@2/bundles/redoc.standalone.js'),
        loadScript('https://cdn.jsdelivr.net/npm/swagger-ui-dist@5/swagger-ui-bundle.js'),
        loadScript('https://cdn.jsdelivr.net/npm/swagger-ui-dist@5/swagger-ui-standalone-preset.js'),
        loadCSS('https://cdn.jsdelivr.net/npm/swagger-ui-dist@5/swagger-ui.css'),
      ]).then(function () {
        contentEl.innerHTML =
          '<div id="hybrid-wrapper">' +
            '<div id="hybrid-redoc"></div>' +
          '</div>' +
          '<button id="hybrid-try-btn">Try It</button>' +
          '<div id="swagger-overlay">' +
            '<div id="swagger-panel">' +
              '<div id="swagger-panel-close">' +
                '<span>Swagger UI — Try Endpoints</span>' +
                '<button id="close-swagger-btn">Close</button>' +
              '</div>' +
              '<div id="swagger-panel-content"></div>' +
            '</div>' +
          '</div>';

        // Render Redoc as the main documentation view
        Redoc.init(specJson, {}, document.getElementById('hybrid-redoc'));

        var overlay = document.getElementById('swagger-overlay');
        var swaggerInitialized = false;

        // "Try It" button opens Swagger panel
        document.getElementById('hybrid-try-btn').addEventListener('click', function () {
          overlay.style.display = 'block';
          if (!swaggerInitialized) {
            swaggerInitialized = true;
            SwaggerUIBundle({
              spec: specJson,
              dom_id: '#swagger-panel-content',
              deepLinking: true,
              presets: [
                SwaggerUIBundle.presets.apis,
                SwaggerUIStandalonePreset,
              ],
              layout: 'StandaloneLayout',
            });
          }
        });

        // Close button
        document.getElementById('close-swagger-btn').addEventListener('click', function () {
          overlay.style.display = 'none';
        });

        // Click outside panel to close
        overlay.addEventListener('click', function (e) {
          if (e.target === overlay) {
            overlay.style.display = 'none';
          }
        });

        // Escape key to close
        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape' && overlay.style.display === 'block') {
            overlay.style.display = 'none';
          }
        });
      });
    }

    // ── Renderer dispatch map ──
    var renderers = {
      scalar: renderScalar,
      swagger: renderSwagger,
      redoc: renderRedoc,
      rapidoc: renderRapidoc,
      stoplight: renderStoplight,
      hybrid: renderHybrid,
    };

    // ── Main ──
    if (!repoId) {
      showError(
        'No repository specified.',
        '?repoId=... is required in the URL'
      );
    } else if (!renderers[renderer]) {
      showError(
        'Unknown renderer: "' + renderer + '"',
        'Supported: scalar, swagger, redoc, rapidoc, stoplight, hybrid'
      );
    } else {
      showLoading('Loading OpenAPI spec for "' + repoId + '" with ' + renderer + ' renderer...');

      var specUrl = '/api/docs/openapi/' + encodeURIComponent(repoId);

      fetch(specUrl)
        .then(function (res) {
          if (!res.ok) throw new Error('Spec not found (HTTP ' + res.status + ')');
          return res.json();
        })
        .then(function (specJson) {
          return renderers[renderer](specJson);
        })
        .catch(function (err) {
          showError(
            'Failed to load API documentation.',
            err.message || 'Unknown error'
          );
        });
    }
  </script>
</body>
</html>
